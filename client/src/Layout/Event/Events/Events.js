import React from 'react';
import '../Events.css'
import { Link, Redirect } from 'react-router-dom';
import instance from '../../../Modules/instances'
export default class Events extends React.Component{
    constructor(props){
        super(props)
        this.state = {
            events : [],
            query : false,
            categories : 'Categories',
            category : {},
            loc : ['Medan','Jakarta','Bandung','Surabaya','Makasar','Yogyakarta'],
            link : false
        }
        this.handleChange  = this.handleChange.bind(this)
        
    }
    handleLocation(link){
        this.setState({link})
    }
    componentDidMount(){
        let query = new URLSearchParams(window.location.search)
        //fetch category 
        instance.get('/category/get.php').then(res => {
            this.setState({
                category : res.data,
                query : query.get('collection')
            })
        })
        //fetch city
        instance.get('/city/get.php').then(res =>{
            let temp = []
            for(let key in res.data)
                temp.push(res.data[key])
            this.setState({loc : temp})
        })
        //fetch event
        instance.get('/event/getAll.php').then(res=>{
            this.setState({
                events : res.data
            })
        })
    }
    componentWillUpdate(){
        let query = new URLSearchParams(window.location.search)
        if(this.state.query !== query.get('collection'))
            this.setState({
                query : query.get('collection')
            })
    }
    handleChange(ev){
        let temp = this.state;
        if(ev.target.label)
            temp[ev.target.accessKey]  = ev.target.value;    
        else 
            temp[ev.target.name]  = ev.target.value;
        this.setState(temp);
    }
    renderEventBtn(price,status){
        if(status === 'SOLD')
            return(<button className="btn partic-btn partic-grey-bg ev-bt" disabled>Sold</button>)
        if(parseInt(price) === 0)
            return(<button className="btn partic-btn partic-yellow-bg ev-bt">Free</button>)
        else 
            return(<button className="btn partic-btn partic-blue-bg ev-bt">Buy</button>)
    }

    renderCategoryOption(){
        let el = []
        for(let key in this.state.category){
            let cat = this.state.category[key]
            el.push(
                <React.Fragment key={cat + 'event'}>
                {/* eslint-disable-next-line  */}
                <option className="dropdown-item" accessKey="categories" value={cat} onMouseDown={this.handleChange}>{cat}</option>
                </React.Fragment>
            )
        }
        return el;
    }

    renderEvents(){
        let el = [];
        this.state.events.forEach((event)=>{
            el.push(
            <div className="row row-evs my-5" key={event.id}>
                <div className="col-sm-12 col-md-3 p-0">
                    <a href={`/events/${event.id}`}><img src={event.image} alt={event.id} width="100%" className="img-evs"/></a>
                </div>
                <div className="col-sm-12 col-md-6">
                    <h2><b>{event.name}</b></h2>
                    <p className="partic-yellow-t">{event.start}</p>                                    
                    <p><b><i className="fa fa-map-marker"></i>&nbsp;&nbsp;&nbsp;{event.location}</b></p>
                </div>
                <div className="col-sm-12 col-md-3">
                    <Link to={`/events/${event.id}`}>
                    {this.renderEventBtn(event.price,event.status)}
                    </Link>
                </div>
            </div>)
        })
        return el;
    }

    render(){
        return(
            <React.Fragment>
                {
                    this.state.link && <Redirect to={window.location.pathname+`?collection=${this.state.link}`} />
                }
                <div id="carouselExampleControls" className="carousel slide mb-5" data-ride="carousel">
                    <div className="carousel-inner shadow" style={{maxHeight : "500px",borderRadius:"20px"}}>
                        <div className="carousel-item active">
                            <img className="d-block w-100" src="https://quotefancy.com/media/wallpaper/3840x2160/1784356-Audrey-Hepburn-Quote-Life-is-a-party-Dress-for-it.jpg" alt="First slide" height="500px"/>
                        </div>
                        <div className="carousel-item">
                            <img className="d-block w-100" src="https://wallpapercave.com/wp/wp2927194.jpg" alt="Second slide" height="500px"/>
                        </div>
                    </div>

                    <a className="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
                        <span className="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span className="sr-only">Previous</span>
                    </a>
                    <a className="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
                        <span className="carousel-control-next-icon" aria-hidden="true"></span>
                        <span className="sr-only">Next</span>
                    </a>
                    
                </div>
                <div className="cont-search p-3">
                    <div className="row">
                        <div className="col-12 col-md-3 " style={{textAlign:"center"}}>
                            <button className="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{this.state.categories}</button>
                            <div className="dropdown-menu">
                                {this.renderCategoryOption()}
                            </div>
                        </div>
                        <div className="col-12 col-md-6 my-3"><input name="search" placeholder="search" value={this.state.search} onChange={this.handleChange} className="inpt form-control"/>
                        </div>
                        <div className="col-4 col-md-3 my-2">
                            <button className="btn partic-btn partic-blue-bg pl-4 pr-4" >Search</button>
                        </div>
                    </div>
                </div>
                <div className="my-4">
                    <div>
                        <h3><b>Collection</b></h3>
                        <span>Checkout event arround you.</span>                        
                    </div>
                    <div className="coll-scroll">
                        {
                            this.state.loc.map((data,index)=>(
                                <React.Fragment key={index}>
                                    {
                                        this.state.loc.indexOf(data)%2 === 0 ? 
                                        <div className="coll-btn" key={data} >
                                        <button className="btn partic-btn partic-yellow-bg" style={{width:"100%"}} onClick={()=>this.handleLocation(data)}>{data}</button>
                                        </div>
                                        : 
                                        <div className="coll-btn">
                                        <button className="btn partic-btn partic-blue-bg" style={{width:"100%"}} onClick={()=>this.handleLocation(data)}>{data}</button>
                                        </div>
                                    }
                                </React.Fragment>                                
                            ))
                        }
                    </div>
                </div>
                <div className="allEvents">
                    <div className="my-5">
                        <h2><b>Events around : </b></h2>
                        {this.state.query && <span className="btn partic-btn partic-blue-bg" style={{width : "200px"}}>{this.state.query}</span>}
                    </div>
                    {
                        this.renderEvents()
                    }
                </div>
            </React.Fragment>
        )
    }
}